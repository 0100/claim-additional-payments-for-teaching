#!/bin/bash

ENVIRONMENT_NAME=$1
APP_SERVICE_TYPE=$2

case $ENVIRONMENT_NAME in
  "development")
    SUBSCRIPTION_ID="8655985a-2f87-44d7-a541-0be9a8c2779d"
    RESOURCE_GROUP="s118d01-app"
    ;;
  "production")
    SUBSCRIPTION_ID="88bd392f-df19-458b-a100-22b4429060ed"
    RESOURCE_GROUP="s118p01-app"
    ;;
  *)
    echo "Could not find a known environment with the name: $ENVIRONMENT_NAME"
    exit 1
    ;;
esac

while [ "$3" ]; do
  case $3 in
    "--tmp-app")
      RESOURCE_GROUP="$RESOURCE_GROUP-tmp"
      ;;
    *)
      echo "Unexpected argument: $3"
      exit 1
      ;;
  esac

  shift
done

case $APP_SERVICE_TYPE in
  "main")
    APP_SERVICE_NAME="$RESOURCE_GROUP-as"
    ;;
  "vsp")
    APP_SERVICE_NAME="$RESOURCE_GROUP-vsp-as"
    ;;
  *)
    echo "Could not find a known app service with the type: $APP_SERVICE_TYPE"
    exit 1
    ;;
esac

SOURCE_SLOT_NAME="staging"

echo "Restarting $APP_SERVICE_TYPE app service $SOURCE_SLOT_NAME slot for $RESOURCE_GROUP..."
az webapp restart --name "$APP_SERVICE_NAME" --resource-group "$RESOURCE_GROUP" --slot "$SOURCE_SLOT_NAME" --subscription="$SUBSCRIPTION_ID"

echo "Swapping $APP_SERVICE_TYPE app service $SOURCE_SLOT_NAME slot to production for $RESOURCE_GROUP..."
az webapp deployment slot swap --name "$APP_SERVICE_NAME" --slot "$SOURCE_SLOT_NAME" --resource-group "$RESOURCE_GROUP" --subscription="$SUBSCRIPTION_ID"
