#!/bin/bash

if [ $# -lt 1 ]; then
  echo "Usage: $0 ENVIRONMENT_NAME"
  exit 1
fi

ENVIRONMENT_NAME=$1

case $ENVIRONMENT_NAME in
  "development")
    SUBSCRIPTION_ID="8655985a-2f87-44d7-a541-0be9a8c2779d"
    RESOURCE_GROUP_PREFIX="s118d01"
    ;;
  "test")
    SUBSCRIPTION_ID="e9299169-9666-4f15-9da9-5332680145af"
    RESOURCE_GROUP_PREFIX="s118t01"
    ;;
  "production")
    SUBSCRIPTION_ID="88bd392f-df19-458b-a100-22b4429060ed"
    RESOURCE_GROUP_PREFIX="s118p01"
    ;;
  *)
    echo "Could not find a known environment with the name: $ENVIRONMENT_NAME"
    exit 1
    ;;
esac

az account set --subscription "$SUBSCRIPTION_ID"

echo "Restarting the container instance..."
az container restart --resource-group=$RESOURCE_GROUP_PREFIX-app --name=$RESOURCE_GROUP_PREFIX-app-worker-aci

echo "Fetching the IP address of the container instance..."
CONTAINER_OUTPUT=$(az container exec --resource-group $RESOURCE_GROUP_PREFIX-app --name $RESOURCE_GROUP_PREFIX-app-worker-aci --exec-command "./bin/report-ip")
CONTAINER_IP=$(echo "$CONTAINER_OUTPUT" | tr -d '\r')

echo "Updating the Postgres firewall to allow the container instance ($CONTAINER_IP) to connect..."
az postgres server firewall-rule create \
  --name worker-aci-ip \
  --start-ip-address "$CONTAINER_IP" \
  --end-ip-address "$CONTAINER_IP" \
  --resource-group $RESOURCE_GROUP_PREFIX-app \
  --server-name $RESOURCE_GROUP_PREFIX-app-db
