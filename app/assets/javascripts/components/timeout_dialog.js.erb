"use strict";

(function() {
  var dialogElement = document.getElementById("timeout_dialog");

  if (!dialogElement) return;

  var continueButtonElement = document.getElementById("continue_session");
  var warningTimeInMinutes = dialogElement.getAttribute("data-warning-in-minutes");
  var timeoutInMinutes = dialogElement.getAttribute("data-timeout-in-minutes");
  var claimInProgress = dialogElement.getAttribute("data-claim-in-progress");
  var timeoutPath = dialogElement.getAttribute("data-timeout-path");
  var timeoutInMilliseconds = (timeoutInMinutes - warningTimeInMinutes) * 60 * 1000;
  var dialog = new window.A11yDialog(dialogElement);

  continueButtonElement.onclick = function() {
    dialog.hide();
  };

  dialog.on("hide", function() {
    dialogElement.setAttribute("aria-hidden", "true");
    refreshSession();
  });

  function refreshSession() {
    Rails.ajax({
      url: "<%= refresh_session_path %>",
      type: "get",
      success: function() {
        clearInterval(window.sessionTimeoutTimer);
        window.sessionTimeoutTimer = setInterval(showTimeoutDialog, timeoutInMilliseconds);
      }
    });
  }

  function sessionTimedOut() {
    clearInterval(window.sessionTimeoutTimer);
    window.location = timeoutPath;
  }

  function showTimeoutDialog() {
    if (claimInProgress === "true") {
      dialogElement.setAttribute("aria-hidden", "false");
      dialog.show();
      setTimeout(sessionTimedOut, warningTimeInMinutes * 60 * 1000);
    }
  }

  window.sessionTimeoutTimer = setInterval(showTimeoutDialog, timeoutInMilliseconds);
})();
