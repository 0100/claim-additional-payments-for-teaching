<% content_for(:page_title) { page_title("View claim #{@claim.reference} for #{policy_service_name(@claim.policy.routing_name)}") } %>

<%= link_to "Back", admin_claims_path, class: "govuk-back-link" %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <%= render("shared/error_summary", instance: @decision, errored_field_id_overrides: { "result": "decision_result_approved" }) if @decision.errors.any? %>

    <% if @claim.payroll_gender_missing? && !@claim.decision_made? %>
      <div class="govuk-body-l govuk-flash__notice">
        <%= t("admin.unknown_payroll_gender_preventing_approval_message") %>
      </div>
    <% end %>

    <% if @claim.pii_removed? %>
      <div class="govuk-body-l govuk-flash__notice">
        This claim had personally identifiable information removed on <%= l(@claim.pii_removed_at.to_date) %>.
      </div>
    <% end %>

    <% if @matching_claims.any? %>
      <div class="govuk-body-l govuk-flash__warning">
        <a href="#claims-with-matches">Details in this claim match those in other claims</a>
      </div>
    <% end %>

    <span class="govuk-caption-xl"><%= @claim.policy.short_name %></span>
    <h1 class="govuk-heading-xl">
      <%= @claim.reference %>
      <span class="govuk-body-m">
        <%= link_to "View checks", admin_claim_checks_path(claim_id: @claim.id), class: "govuk-link" %>
      </span>
    </h1>

    <%= render("info_panel_identity_unconfirmed", school: @claim.school) unless @claim.identity_confirmed? %>

    <%= render "admin/claims/answer_section", {heading: "Personal details", answers: admin_personal_details(@claim)} %>

    <%= render "admin/claims/answer_section", {heading: "Eligibility details", answers: admin_eligibility_answers(@claim)} %>

    <%= render "admin/claims/answer_section", {heading: "Student loan details", answers: admin_student_loan_details(@claim)} %>

    <%= render "admin/claims/answer_section", {heading: "Submission details", answers: admin_submission_details(@claim)} %>

    <% if @matching_claims.any? %>
      <table id="claims-with-matches" class="govuk-table govuk-!-margin-bottom-9">
        <caption class="govuk-table__caption govuk-heading-l">Claims with matching details</caption>
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">Claim</th>
            <th scope="col" class="govuk-table__header">Matching details</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          <% @matching_claims.each do |matching_claim| %>
            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header"><%= link_to matching_claim.reference, [:admin, matching_claim], class: "govuk-link" %>
              <td class="govuk-table__cell">
                <ul class="govuk-list">
                <% matching_attributes(@claim, matching_claim).each do |attribute| %>
                  <li><%= attribute %></li>
                <% end %>
                </ul>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>

    <% if @decision.persisted? %>
      <%= render "admin/claims/answer_section", {heading: "Claim decision details", answers: admin_decision_details(@decision)} %>
    <% else %>
      <%= render "admin/decisions/decision_form", claim: @claim, decision: @decision, claims_preventing_payment: @claims_preventing_payment %>
  <% end %>
  </div>
</div>
