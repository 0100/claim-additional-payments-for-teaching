# Ruby
# Package your Ruby project.
# Add steps that install rails, analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/ruby

trigger:
  - master

pool:
  vmImage: ubuntu-latest

variables:
  - group: docker-settings

steps:
  - script: docker-compose -f docker-compose.test.yml build
    displayName: Build Docker image for testing
  - script: docker-compose -f docker-compose.test.yml run --rm web bundle exec rake
    displayName: Run tests via rake default

  - script: docker login -u $(dockerId) -p $pass
    env:
      pass: $(dockerPassword)
    displayName: Login to DockerHub
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
  - script: docker build --file=Dockerfile --tag=$(dockerRegistry)/$(dockerImageName):latest --target=web .
    displayName: Build Docker image for deployment
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
